<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books API</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    
    <script>
        window.onload = function() {
        const rootUrl = '';
        const statusElement = document.getElementById('responseStatus');
        const headersElement = document.getElementById('responseHeaders');
        const logElement = document.getElementById('response-log');

        const sendRequest = async (url, method, body = null, attempt = 0) => {
            statusElement.textContent = `Sending ${method} request...`;
            headersElement.textContent = '';
            logElement.textContent = 'Loading...';

        const headers = {
            'Content-Type': 'application/json',
        };

        try {
            const fetchOptions = {
                method,
                headers,
                body: body ? JSON.stringify(body) : undefined,
            };

            const response = await fetch(url, fetchOptions);

            const responseHeaders = {};
            response.headers.forEach((value, key) => {
                responseHeaders[key] = value;
            });
            headersElement.textContent = JSON.stringify(responseHeaders, null, 2);

            statusElement.textContent = `${response.status} ${response.statusText}`;
            statusElement.style.color = (response.status >= 400) ? 'red' : 'green';

            if (method === 'HEAD' || response.status === 204) {
                logElement.textContent = '(Success, No content in body)';
                return;
            }

            const bodyText = await response.text();

            try {
                const json = JSON.parse(bodyText);
                logElement.textContent = JSON.stringify(json, null, 2);
            } catch (e) {
                logElement.textContent = bodyText;
            } 

        // Resource Refrences: https://www.geeksforgeeks.org/javascript/how-to-delay-a-loop-in-javascript-using-async-await-with-promise/,
        // https://v-checha.medium.com/advanced-node-js-patterns-implementing-robust-retry-logic-656cf70f8ee9  
        } catch (error) {
            if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                return sendRequest(url, method, body, attempt + 1);
            }

            statusElement.textContent = `Network Error: Failed after ${maxRetries} attempts.`;
            statusElement.style.color = 'red';
            logElement.textContent = `Error: ${error.message}`;
          }
        };

        const maxRetries = 3;

        const urlFieldElement = document.getElementById('urlField');
        const methodSelectElement = document.getElementById('methodSelect');

        document.getElementById('getForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const path = urlFieldElement.value;
            const method = methodSelectElement.value;

            sendRequest(`${rootUrl}${path}`, method);
        });

        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const originalTitle = document.getElementById('editOriginalTitle').value.trim();
            if (!originalTitle) {
                statusElement.textContent = 'Error: Original Title is required to find the book.';
                statusElement.style.color = 'red';
                return;
            }

            const newTitle = document.getElementById('editNewTitle').value.trim();
            const newAuthor = document.getElementById('editAuthor').value.trim();
            const newYear = document.getElementById('editYear').value.trim();
            const newGenres = document.getElementById('editGenres').value.trim();

            const updateData = {};
            if (newTitle) updateData.title = newTitle;
            if (newAuthor) updateData.author = newAuthor;

            if (newYear) {
                const yearInt = parseInt(newYear, 10);
                if (!isNaN(yearInt)) {
                    updateData.year = yearInt;
                }
            }

            if (newGenres) {
                updateData.genres = newGenres.split(',').map(g => g.trim()).filter(g => g.length > 0);
            }

            if (Object.keys(updateData).length === 0) {
                statusElement.textContent = 'Error: No new fields provided for update.';
                statusElement.style.color = 'red';
                return;
            }

            const encodedTitle = encodeURIComponent(originalTitle);
            const url = `${rootUrl}/api/books/${encodedTitle}`;

            sendRequest(url, 'POST', updateData);
        });

        document.getElementById('post').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('postTitle').value;
            const author = document.getElementById('postAuthor').value;
            const genres = document.getElementById('postGenres').value.split(',').map(g => g.trim()).filter(g => g.length > 0);
            const year = document.getElementById('postYear').value;

            if (!title || !author || !genres.length || !year) {
                statusElement.textContent = 'Error: Please fill out all required fields.';
                statusElement.style.color = 'red';
                return
            }

            const bookData = {
                title,
                author, 
                genres,
                year: parseInt(year, 10),
            };

            sendRequest(`${rootUrl}/api/books`, 'POST', bookData);
        });
    };
    </script>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="/documentation.html" style="padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">View Documentation Here</a>
        </div>
        <h1>Book API</h1>
        <section id="top">
            <h3 style="margin-top: 0,">GET / HEAD Request</h3>
            <form id="getForm">
                <label for="urlField">Endpoint: </label>
                <input id="urlField" type="text" name="urlField" list="endPoint" value="/api/books"/>
                <datalist id="endPoint">
                    <option value="/api/books">/api/books (All books)</option>
                    <option value="/api/booksByTitle">/api/booksByTitle</option>
                    <option value="/api/genres">/api/genres</option>
                    <option value="/api/stats">/api/stats</option>
                    <option value="/api/authors">/api/authors</option>
                    <option value="/notReal">/notReal (404)</option>
                </datalist>

                <label for="methodSelect">Method: </label>
                <select id="methodSelect" name="methodSelect">
                    <option value="GET">GET</option>
                    <option value="HEAD">HEAD</option>
                </select>
                <input type="submit" value="Send Request" />
            </form>

            <h2>Edit Book</h2>
            <form id="editForm">
                <label for="editOriginalTitle">Original Title (to find book):</label>
                <input type="text" id="editOriginalTitle" required><br>

                <label for="editNewTitle">New Title:</label>
                <input type="text" id="editNewTitle"><br>

                <label for="editAuthor">New Author:</label>
                <input type="text" id="editAuthor"><br>

                <label for="editYear">New Year:</label>
                <input type="number" id="editYear"><br>

                <label for="editGenres">New Genres:</label>
                <input type="text" id="editGenres"><br>

                <input type="submit" value="Edit Book" />
            </form>

            <h3 style="margin-top: 15px;">POST /api/books (Add Book)</h3>
            <form id="post">
                <label for="postTitle">Title: </label>
                <input id="postTitle" type="text" name="Title" placeHolder="Title (Requried)" required />

                <label for="postAuthor">Author: </label>
                <input id="postAuthor" type="text" name="author" placedHolder="Author (Required)" required />

                <label for="postGenres">Genres: </label>
                <input id="postGenres" type="text" name="genres" placedHolder="Sci-Fi, Fiction (Required)" required />

                <label for="postYear">Year: </label>
                <input id="postYear" type="number" name="year" placedHolder="Year (Required)" required min="1000" max="2025" step="1" />

                <input type="submit" value="Add Book" />
            </form>
        </section>

        <section id="content">
            <h3>API Response Details</h3>
            <p>Status: <strong id="responseStatus">Awaiting request...</strong></p>
            <p>Headers: </p>
            <pre id="responseHeaders" style="font-size: 0.8em; color: #888;">(Headers appear here)</pre>
            <p>Body: </p>
            <pre id="response-log">(Body appears here)</pre>
        </section>
    </div>
    
</body>
</html>